<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garmin HRV Biofeedback</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        .breathing-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(99,102,241,0.8) 0%, rgba(99,102,241,0.2) 70%);
            box-shadow: 0 0 30px rgba(99,102,241,0.4);
            transition: transform 0.1s linear, background 1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            color: white;
            position: relative;
        }
        
        .breathing-text {
            position: absolute;
            font-size: 1rem;
            bottom: -40px;
            opacity: 0.8;
        }

        /* Chart Canvas Container */
        .chart-container {
            position: relative;
            height: 150px;
            width: 100%;
        }
        
        canvas {
            width: 100%;
            height: 100%;
        }

        .stat-card {
            background-color: #1e293b;
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .status-disconnected { background-color: #ef4444; color: white; }
        .status-connected { background-color: #22c55e; color: white; }
        .status-scanning { background-color: #eab308; color: black; }

        .instruction-box {
            background: rgba(234, 179, 8, 0.1);
            border: 1px solid rgba(234, 179, 8, 0.3);
            border-radius: 8px;
            padding: 12px;
            font-size: 0.85rem;
            color: #fde047;
            text-align: left;
            margin-bottom: 10px;
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Header -->
    <header class="p-4 bg-slate-900 border-b border-slate-700 flex justify-between items-center shadow-md z-10 shrink-0">
        <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400">
            HRV Biofeedback
        </h1>
        <div id="connectionStatus" class="status-badge status-disconnected">æœªé€£æ¥</div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow flex flex-col items-center justify-start p-4 space-y-4 overflow-y-auto">
        
        <!-- Instruction for iOS -->
        <div class="w-full max-w-md instruction-box">
            <strong>âš ï¸ é€£æ¥å°æ’‡æ­¥ï¼š</strong>
            <ul class="list-disc ml-4 mt-1 space-y-1 text-slate-300">
                <li>è«‹ä¿æŒæ‰‹éŒ¶è¢å¹•äº®èµ·ã€‚</li>
                <li>è‹¥å‡ºç¾ undefined éŒ¯èª¤ï¼Œè«‹<strong>é‡æ–°æ•´ç†ç¶²é </strong>å¾Œå†è©¦ã€‚</li>
                <li>è‹¥ä¸€ç›´å¤±æ•—ï¼Œè«‹é—œé–‰ iPhone è—ç‰™å†é‡æ–°é–‹å•Ÿã€‚</li>
            </ul>
        </div>

        <!-- Controls -->
        <div class="w-full max-w-md flex flex-col gap-3">
            <div class="grid grid-cols-2 gap-3">
                <button id="connectBtn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-2 rounded-xl transition shadow-lg flex items-center justify-center gap-1 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7 7 10 10-5 5V2l5 5L7 17"/></svg>
                    æ¨¡å¼A: æœå°‹å¿ƒç‡
                </button>
                <button id="connectBtnAll" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-2 rounded-xl transition shadow-lg flex items-center justify-center gap-1 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                    æ¨¡å¼B: æœå°‹å…¨éƒ¨
                </button>
            </div>
            <button id="simulateBtn" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-xl transition shadow-lg border border-slate-600 text-sm">
                æ¸¬è©¦ä»‹é¢ (æ¨¡æ“¬æ•¸æ“š)
            </button>
        </div>

        <!-- Biofeedback Visualizer -->
        <div class="py-4 relative flex flex-col items-center justify-center shrink-0">
            <div id="visualizer" class="breathing-circle">
                <span id="hrDisplay">--</span>
                <div id="breathGuideText" class="breathing-text">æº–å‚™é–‹å§‹</div>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="w-full max-w-md grid grid-cols-3 gap-3">
            <div class="stat-card">
                <div class="text-slate-400 text-[10px] uppercase tracking-wider">å¿ƒç‡ (BPM)</div>
                <div id="bpmValue" class="text-xl font-bold text-white mt-1">--</div>
            </div>
            <div class="stat-card">
                <div class="text-slate-400 text-[10px] uppercase tracking-wider">HRV (rMSSD)</div>
                <div id="hrvValue" class="text-xl font-bold text-emerald-400 mt-1">--</div>
            </div>
            <div class="stat-card">
                <div class="text-slate-400 text-[10px] uppercase tracking-wider">å£“åŠ›æŒ‡æ•¸</div>
                <div id="stressValue" class="text-xl font-bold text-blue-400 mt-1">--</div>
            </div>
        </div>

        <!-- Realtime Graph -->
        <div class="w-full max-w-md bg-slate-800 rounded-xl p-3 shadow-inner border border-slate-700 shrink-0">
            <div class="text-xs text-slate-400 mb-2 flex justify-between">
                <span>RR Interval (ms)</span>
                <span class="text-emerald-500">Live Data</span>
            </div>
            <div class="chart-container">
                <canvas id="rrChart"></canvas>
            </div>
        </div>

        <!-- Logs -->
        <div class="w-full max-w-md flex-grow min-h-[100px]">
            <div class="text-xs text-slate-500 mb-1">ç³»çµ±æ—¥èªŒ</div>
            <div id="consoleLog" class="h-full max-h-32 bg-black/30 rounded-lg p-2 font-mono text-xs text-green-400 overflow-y-auto border border-slate-800">
                > ç­‰å¾…é€£æ¥...<br>
                > è«‹ç¢ºä¿æ‰‹éŒ¶åœ¨å»£æ’­å¿ƒç‡æ¨¡å¼ã€‚
            </div>
        </div>
    </main>

    <script>
        // --- è¨­å®šèˆ‡è®Šæ•¸ ---
        const CHART_LENGTH = 50;
        let rrIntervals = []; // å„²å­˜ RR é–“æœŸ
        let chartData = new Array(CHART_LENGTH).fill(800);
        let bluetoothDevice;
        let heartRateCharacteristic;
        let isSimulating = false;
        let simulationInterval;
        
        // Biofeedback åƒæ•¸
        const BREATH_CYCLE_SEC = 10; // 10ç§’ä¸€å€‹å‘¼å¸å¾ªç’° (6æ¬¡/åˆ†)
        const INHALE_RATIO = 0.4; // å¸æ°£ä½” 40% (4ç§’å¸, 6ç§’å)
        
        // --- DOM å…ƒç´  ---
        const connectBtn = document.getElementById('connectBtn');
        const connectBtnAll = document.getElementById('connectBtnAll');
        const simulateBtn = document.getElementById('simulateBtn');
        const statusBadge = document.getElementById('connectionStatus');
        const logDiv = document.getElementById('consoleLog');
        const visualizer = document.getElementById('visualizer');
        const bpmDisplay = document.getElementById('bpmValue');
        const hrvDisplay = document.getElementById('hrvValue');
        const hrCenterDisplay = document.getElementById('hrDisplay');
        const stressDisplay = document.getElementById('stressValue');
        const breathText = document.getElementById('breathGuideText');
        
        // --- Canvas Chart ---
        const canvas = document.getElementById('rrChart');
        const ctx = canvas.getContext('2d');
        
        function resizeCanvas() {
            if(canvas.parentElement) {
                canvas.width = canvas.parentElement.clientWidth;
                canvas.height = canvas.parentElement.clientHeight;
            }
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function drawChart() {
            const w = canvas.width;
            const h = canvas.height;
            ctx.clearRect(0, 0, w, h);
            
            // Grid lines
            ctx.strokeStyle = '#334155';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(0, h/2);
            ctx.lineTo(w, h/2);
            ctx.stroke();

            // Data Line
            if (chartData.length < 2) return;

            const maxRR = Math.max(...chartData, 1200);
            const minRR = Math.min(...chartData, 500);
            const range = maxRR - minRR || 1;

            ctx.beginPath();
            ctx.strokeStyle = '#10b981'; // Emerald 500
            ctx.lineWidth = 2;

            chartData.forEach((val, i) => {
                const x = (i / (CHART_LENGTH - 1)) * w;
                const normalizedY = 1 - (val - minRR) / range; 
                const y = (normalizedY * (h - 20)) + 10; 
                
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
        }

        // --- æ ¸å¿ƒé‚è¼¯ï¼šæ›´æ–°æ•¸æ“šèˆ‡ UI ---
        
        function updateStats(hr, rr) {
            bpmDisplay.innerText = hr;
            hrCenterDisplay.innerText = hr;

            if (rr && rr > 0) {
                if (rr < 300 || rr > 2000) return; // Filter noise

                chartData.push(rr);
                if (chartData.length > CHART_LENGTH) chartData.shift();
                drawChart();

                rrIntervals.push(rr);
                if (rrIntervals.length > 20) rrIntervals.shift();

                calculateHRV();
            }
        }

        function calculateHRV() {
            if (rrIntervals.length < 5) return;
            let sumSquaredDiffs = 0;
            for (let i = 1; i < rrIntervals.length; i++) {
                const diff = rrIntervals[i] - rrIntervals[i - 1];
                sumSquaredDiffs += diff * diff;
            }
            const meanSquaredDiff = sumSquaredDiffs / (rrIntervals.length - 1);
            const rmssd = Math.sqrt(meanSquaredDiff);
            const rmssdRounded = Math.round(rmssd);

            hrvDisplay.innerText = rmssdRounded;
            updateBiofeedbackColor(rmssdRounded);
        }

        function updateBiofeedbackColor(rmssd) {
            let color, stressText;
            if (rmssd < 25) {
                color = 'rgba(239, 68, 68, 0.8)';
                stressText = "å£“åŠ›é«˜";
                stressDisplay.className = "text-xl font-bold text-red-500 mt-1";
            } else if (rmssd < 50) {
                color = 'rgba(234, 179, 8, 0.8)';
                stressText = "å£“åŠ›ä¸­";
                stressDisplay.className = "text-xl font-bold text-yellow-500 mt-1";
            } else {
                color = 'rgba(34, 197, 94, 0.8)';
                stressText = "æ”¾é¬†";
                stressDisplay.className = "text-xl font-bold text-green-500 mt-1";
            }

            visualizer.style.background = `radial-gradient(circle, ${color} 0%, ${color.replace('0.8', '0.2')} 70%)`;
            visualizer.style.boxShadow = `0 0 30px ${color.replace('0.8', '0.4')}`;
            stressDisplay.innerText = stressText;
        }

        function startBreathingGuide() {
            const startTime = Date.now();
            function animate() {
                const now = Date.now();
                const elapsed = (now - startTime) / 1000;
                const cycleTime = elapsed % BREATH_CYCLE_SEC;
                
                if (cycleTime < BREATH_CYCLE_SEC * INHALE_RATIO) {
                    visualizer.style.transform = 'scale(1.3)';
                    breathText.innerText = "å¸æ°£...";
                } else {
                    visualizer.style.transform = 'scale(0.85)';
                    breathText.innerText = "åæ°£...";
                }
                requestAnimationFrame(animate);
            }
            animate();
        }
        startBreathingGuide();

        // --- Bluetooth è™•ç† ---

        function log(msg) {
            const time = new Date().toLocaleTimeString('en-US', {hour12: false, hour: "numeric", minute: "numeric", second: "numeric"});
            logDiv.innerHTML += `<div>[${time}] ${msg}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function connectDevice(mode) {
            try {
                log(`å˜—è©¦é€£æ¥ (æ¨¡å¼${mode})...`);
                statusBadge.className = 'status-badge status-scanning';
                statusBadge.innerText = 'æœå°‹ä¸­';

                // ä½¿ç”¨å­—ä¸² ID ç›¸å®¹æ€§è¼ƒä½³
                const SERVICE_ID = 'heart_rate';
                const CHARACTERISTIC_ID = 'heart_rate_measurement';

                let options = {};
                if (mode === 'A') {
                    options = {
                        filters: [{ services: [SERVICE_ID] }]
                    };
                } else {
                    options = {
                        acceptAllDevices: true,
                        optionalServices: [SERVICE_ID]
                    };
                }

                bluetoothDevice = await navigator.bluetooth.requestDevice(options);

                log(`å·²é¸å–: ${bluetoothDevice.name}`);
                bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);

                log('é€£æ¥ä¸­ (è‹¥å¤±æ•—å°‡è‡ªå‹•é‡è©¦)...');
                
                let server = null;
                const maxRetries = 3;
                
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        server = await bluetoothDevice.gatt.connect();
                        log('GATT é€£æ¥æˆåŠŸï¼');
                        break; 
                    } catch (err) {
                        console.warn(`Attempt ${i + 1} failed:`, err);
                        if (i < maxRetries - 1) {
                            log(`å˜—è©¦ ${i + 1} å¤±æ•—ï¼Œ1.5ç§’å¾Œé‡è©¦...`);
                            await new Promise(resolve => setTimeout(resolve, 1500));
                        } else {
                            throw err;
                        }
                    }
                }

                if (!server) {
                    throw new Error("ç„¡æ³•å»ºç«‹ GATT ä¼ºæœå™¨é€£ç·š");
                }

                log('ç­‰å¾…è£ç½®ç©©å®š (2ç§’)...');
                await new Promise(resolve => setTimeout(resolve, 2000));

                // ä¿®æ­£ï¼šåœ¨å–å¾—ç‰¹å®šæœå‹™å‰ï¼Œå…ˆå–å¾—æ‰€æœ‰æœå‹™ä¾†è§¸ç™¼ç™¼ç¾
                log('æ­£åœ¨å–šé†’æœå‹™åˆ—è¡¨...');
                try {
                    await server.getPrimaryServices(); 
                } catch(e) {
                    console.warn("Service discovery warning:", e);
                    // å¿½ç•¥éŒ¯èª¤ï¼Œç¹¼çºŒå˜—è©¦
                }

                log('å–å¾—å¿ƒç‡æœå‹™...');
                const service = await server.getPrimaryService(SERVICE_ID);

                log('å–å¾—ç‰¹å¾µå€¼...');
                const characteristic = await service.getCharacteristic(CHARACTERISTIC_ID);

                log('å•Ÿå‹•ç›£è½...');
                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', handleHeartRateMeasurement);
                heartRateCharacteristic = characteristic; 

                statusBadge.className = 'status-badge status-connected';
                statusBadge.innerText = 'å·²é€£æ¥';
                
                connectBtn.disabled = true;
                connectBtnAll.disabled = true;
                connectBtn.classList.add('opacity-50', 'cursor-not-allowed');
                connectBtnAll.classList.add('opacity-50', 'cursor-not-allowed');
                
                stopSimulation();

            } catch (error) {
                console.error("BT Error:", error);
                statusBadge.className = 'status-badge status-disconnected';
                statusBadge.innerText = 'å¤±æ•—';
                
                if (error.name === 'NotFoundError') {
                    log('æç¤º: æ‚¨å–æ¶ˆäº†é¸å–æˆ–æœªæ‰¾åˆ°è£ç½®');
                } else if (error.name === 'SecurityError') {
                    log('âš ï¸ ç’°å¢ƒé™åˆ¶: é è¦½è¦–çª—ä¸æ”¯æ´è—ç‰™ã€‚');
                    alert("âš ï¸ é è¦½ç’°å¢ƒé™åˆ¶\n\nè«‹å°‡æª”æ¡ˆä¸Šå‚³è‡³ GitHub Pages é€²è¡Œæ¸¬è©¦ã€‚");
                } else {
                    // è©³ç´°éŒ¯èª¤è§£æ
                    const errorName = error.name || 'UnknownError';
                    const errorMessage = error.message || 'No message provided';
                    log(`éŒ¯èª¤: ${errorName} - ${errorMessage}`);
                    
                    if (errorMessage.includes("undefined")) {
                        log('ğŸ’¡ å»ºè­°ï¼šè«‹ã€Œé‡æ–°æ•´ç†ã€ç¶²é ï¼Œä¸¦ç¢ºèªæ‰‹éŒ¶è¢å¹•äº®èµ·ã€‚');
                    }
                }
            }
        }

        function handleHeartRateMeasurement(event) {
            const value = event.target.value;
            parseHeartRate(value);
        }

        function parseHeartRate(value) {
            const flags = value.getUint8(0);
            const rate16Bits = flags & 0x1;
            let heartRate;
            let offset = 1;
            
            if (rate16Bits) {
                heartRate = value.getUint16(offset, true);
                offset += 2;
            } else {
                heartRate = value.getUint8(offset);
                offset += 1;
            }

            const rrPresent = flags & 0x10;
            let rrInterval = null;
            if (rrPresent) {
                const energyPresent = flags & 0x8;
                if (energyPresent) offset += 2;

                while (offset + 1 < value.byteLength) {
                    const rawRR = value.getUint16(offset, true);
                    rrInterval = Math.round((rawRR / 1024) * 1000);
                    offset += 2;
                }
            }
            updateStats(heartRate, rrInterval);
        }

        function onDisconnected(event) {
            log('è£ç½®å·²æ–·é–‹');
            statusBadge.className = 'status-badge status-disconnected';
            statusBadge.innerText = 'å·²æ–·é–‹';
            connectBtn.disabled = false;
            connectBtnAll.disabled = false;
            connectBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            connectBtnAll.classList.remove('opacity-50', 'cursor-not-allowed');
        }

        // --- æ¨¡æ“¬æ¨¡å¼ ---
        function startSimulation() {
            if (isSimulating) return;
            isSimulating = true;
            log('å•Ÿå‹•æ¨¡æ“¬');
            let simHR = 70;
            let simRR = 850; 
            simulationInterval = setInterval(() => {
                const now = Date.now() / 1000;
                const breathPhase = Math.sin(now * (Math.PI * 2 / BREATH_CYCLE_SEC));
                simRR = 850 + (breathPhase * 100) + (Math.random() - 0.5) * 50;
                simHR = Math.round(60000 / simRR);
                updateStats(simHR, Math.round(simRR));
            }, 1000);
        }

        function stopSimulation() {
            isSimulating = false;
            clearInterval(simulationInterval);
            simulateBtn.innerText = "æ¸¬è©¦ä»‹é¢ (æ¨¡æ“¬æ•¸æ“š)";
            simulateBtn.classList.remove('bg-green-600');
        }

        // Event Listeners
        connectBtn.addEventListener('click', () => connectDevice('A'));
        connectBtnAll.addEventListener('click', () => connectDevice('B'));
        
        simulateBtn.addEventListener('click', () => {
            if (isSimulating) {
                stopSimulation();
            } else {
                startSimulation();
                simulateBtn.innerText = "åœæ­¢æ¨¡æ“¬";
                simulateBtn.classList.add('bg-green-600');
            }
        });

    </script>
</body>
</html>
