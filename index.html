<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garmin HRV Biofeedback</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        .breathing-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(99,102,241,0.8) 0%, rgba(99,102,241,0.2) 70%);
            box-shadow: 0 0 30px rgba(99,102,241,0.4);
            transition: transform 0.1s linear, background 1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            color: white;
            position: relative;
        }
        
        .breathing-text {
            position: absolute;
            font-size: 1rem;
            bottom: -40px;
            opacity: 0.8;
        }

        /* Chart Canvas Container */
        .chart-container {
            position: relative;
            height: 150px;
            width: 100%;
        }
        
        canvas {
            width: 100%;
            height: 100%;
        }

        .stat-card {
            background-color: #1e293b;
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .status-disconnected { background-color: #ef4444; color: white; }
        .status-connected { background-color: #22c55e; color: white; }
        .status-scanning { background-color: #eab308; color: black; }

        .instruction-box {
            background: rgba(234, 179, 8, 0.1);
            border: 1px solid rgba(234, 179, 8, 0.3);
            border-radius: 8px;
            padding: 12px;
            font-size: 0.85rem;
            color: #fde047;
            text-align: left;
            margin-bottom: 10px;
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Header -->
    <header class="p-4 bg-slate-900 border-b border-slate-700 flex justify-between items-center shadow-md z-10 shrink-0">
        <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400">
            HRV Biofeedback
        </h1>
        <div id="connectionStatus" class="status-badge status-disconnected">未連接</div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow flex flex-col items-center justify-start p-4 space-y-4 overflow-y-auto">
        
        <!-- Instruction for iOS -->
        <div class="w-full max-w-md instruction-box">
            <strong>⚠️ 連接小撇步：</strong>
            <ul class="list-disc ml-4 mt-1 space-y-1 text-slate-300">
                <li>請保持手錶螢幕亮起。</li>
                <li>若連接失敗，程式會自動重試 3 次。</li>
                <li>若一直失敗，請關閉 iPhone 藍牙再重新開啟。</li>
            </ul>
        </div>

        <!-- Controls -->
        <div class="w-full max-w-md flex flex-col gap-3">
            <div class="grid grid-cols-2 gap-3">
                <button id="connectBtn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-2 rounded-xl transition shadow-lg flex items-center justify-center gap-1 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7 7 10 10-5 5V2l5 5L7 17"/></svg>
                    模式A: 搜尋心率
                </button>
                <button id="connectBtnAll" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-2 rounded-xl transition shadow-lg flex items-center justify-center gap-1 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                    模式B: 搜尋全部
                </button>
            </div>
            <button id="simulateBtn" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-xl transition shadow-lg border border-slate-600 text-sm">
                測試介面 (模擬數據)
            </button>
        </div>

        <!-- Biofeedback Visualizer -->
        <div class="py-4 relative flex flex-col items-center justify-center shrink-0">
            <div id="visualizer" class="breathing-circle">
                <span id="hrDisplay">--</span>
                <div id="breathGuideText" class="breathing-text">準備開始</div>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="w-full max-w-md grid grid-cols-3 gap-3">
            <div class="stat-card">
                <div class="text-slate-400 text-[10px] uppercase tracking-wider">心率 (BPM)</div>
                <div id="bpmValue" class="text-xl font-bold text-white mt-1">--</div>
            </div>
            <div class="stat-card">
                <div class="text-slate-400 text-[10px] uppercase tracking-wider">HRV (rMSSD)</div>
                <div id="hrvValue" class="text-xl font-bold text-emerald-400 mt-1">--</div>
            </div>
            <div class="stat-card">
                <div class="text-slate-400 text-[10px] uppercase tracking-wider">壓力指數</div>
                <div id="stressValue" class="text-xl font-bold text-blue-400 mt-1">--</div>
            </div>
        </div>

        <!-- Realtime Graph -->
        <div class="w-full max-w-md bg-slate-800 rounded-xl p-3 shadow-inner border border-slate-700 shrink-0">
            <div class="text-xs text-slate-400 mb-2 flex justify-between">
                <span>RR Interval (ms)</span>
                <span class="text-emerald-500">Live Data</span>
            </div>
            <div class="chart-container">
                <canvas id="rrChart"></canvas>
            </div>
        </div>

        <!-- Logs -->
        <div class="w-full max-w-md flex-grow min-h-[100px]">
            <div class="text-xs text-slate-500 mb-1">系統日誌</div>
            <div id="consoleLog" class="h-full max-h-32 bg-black/30 rounded-lg p-2 font-mono text-xs text-green-400 overflow-y-auto border border-slate-800">
                > 等待連接...<br>
                > 若失敗請嘗試重新開關手機藍牙。
            </div>
        </div>
    </main>

    <script>
        // --- 設定與變數 ---
        const CHART_LENGTH = 50;
        let rrIntervals = []; // 儲存 RR 間期
        let chartData = new Array(CHART_LENGTH).fill(800);
        let bluetoothDevice;
        let heartRateCharacteristic;
        let isSimulating = false;
        let simulationInterval;
        
        // Biofeedback 參數
        const BREATH_CYCLE_SEC = 10; // 10秒一個呼吸循環 (6次/分)
        const INHALE_RATIO = 0.4; // 吸氣佔 40% (4秒吸, 6秒吐)
        
        // --- DOM 元素 ---
        const connectBtn = document.getElementById('connectBtn');
        const connectBtnAll = document.getElementById('connectBtnAll');
        const simulateBtn = document.getElementById('simulateBtn');
        const statusBadge = document.getElementById('connectionStatus');
        const logDiv = document.getElementById('consoleLog');
        const visualizer = document.getElementById('visualizer');
        const bpmDisplay = document.getElementById('bpmValue');
        const hrvDisplay = document.getElementById('hrvValue');
        const hrCenterDisplay = document.getElementById('hrDisplay');
        const stressDisplay = document.getElementById('stressValue');
        const breathText = document.getElementById('breathGuideText');
        
        // --- Canvas Chart ---
        const canvas = document.getElementById('rrChart');
        const ctx = canvas.getContext('2d');
        
        function resizeCanvas() {
            if(canvas.parentElement) {
                canvas.width = canvas.parentElement.clientWidth;
                canvas.height = canvas.parentElement.clientHeight;
            }
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function drawChart() {
            const w = canvas.width;
            const h = canvas.height;
            ctx.clearRect(0, 0, w, h);
            
            // Grid lines
            ctx.strokeStyle = '#334155';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(0, h/2);
            ctx.lineTo(w, h/2);
            ctx.stroke();

            // Data Line
            if (chartData.length < 2) return;

            const maxRR = Math.max(...chartData, 1200);
            const minRR = Math.min(...chartData, 500);
            const range = maxRR - minRR || 1;

            ctx.beginPath();
            ctx.strokeStyle = '#10b981'; // Emerald 500
            ctx.lineWidth = 2;

            chartData.forEach((val, i) => {
                const x = (i / (CHART_LENGTH - 1)) * w;
                const normalizedY = 1 - (val - minRR) / range; 
                const y = (normalizedY * (h - 20)) + 10; 
                
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
        }

        // --- 核心邏輯：更新數據與 UI ---
        
        function updateStats(hr, rr) {
            bpmDisplay.innerText = hr;
            hrCenterDisplay.innerText = hr;

            if (rr && rr > 0) {
                if (rr < 300 || rr > 2000) return; // Filter noise

                chartData.push(rr);
                if (chartData.length > CHART_LENGTH) chartData.shift();
                drawChart();

                rrIntervals.push(rr);
                if (rrIntervals.length > 20) rrIntervals.shift();

                calculateHRV();
            }
        }

        function calculateHRV() {
            if (rrIntervals.length < 5) return;
            let sumSquaredDiffs = 0;
            for (let i = 1; i < rrIntervals.length; i++) {
                const diff = rrIntervals[i] - rrIntervals[i - 1];
                sumSquaredDiffs += diff * diff;
            }
            const meanSquaredDiff = sumSquaredDiffs / (rrIntervals.length - 1);
            const rmssd = Math.sqrt(meanSquaredDiff);
            const rmssdRounded = Math.round(rmssd);

            hrvDisplay.innerText = rmssdRounded;
            updateBiofeedbackColor(rmssdRounded);
        }

        function updateBiofeedbackColor(rmssd) {
            let color, stressText;
            if (rmssd < 25) {
                color = 'rgba(239, 68, 68, 0.8)';
                stressText = "壓力高";
                stressDisplay.className = "text-xl font-bold text-red-500 mt-1";
            } else if (rmssd < 50) {
                color = 'rgba(234, 179, 8, 0.8)';
                stressText = "壓力中";
                stressDisplay.className = "text-xl font-bold text-yellow-500 mt-1";
            } else {
                color = 'rgba(34, 197, 94, 0.8)';
                stressText = "放鬆";
                stressDisplay.className = "text-xl font-bold text-green-500 mt-1";
            }

            visualizer.style.background = `radial-gradient(circle, ${color} 0%, ${color.replace('0.8', '0.2')} 70%)`;
            visualizer.style.boxShadow = `0 0 30px ${color.replace('0.8', '0.4')}`;
            stressDisplay.innerText = stressText;
        }

        function startBreathingGuide() {
            const startTime = Date.now();
            function animate() {
                const now = Date.now();
                const elapsed = (now - startTime) / 1000;
                const cycleTime = elapsed % BREATH_CYCLE_SEC;
                
                if (cycleTime < BREATH_CYCLE_SEC * INHALE_RATIO) {
                    visualizer.style.transform = 'scale(1.3)';
                    breathText.innerText = "吸氣...";
                } else {
                    visualizer.style.transform = 'scale(0.85)';
                    breathText.innerText = "吐氣...";
                }
                requestAnimationFrame(animate);
            }
            animate();
        }
        startBreathingGuide();

        // --- Bluetooth 處理 ---

        function log(msg) {
            const time = new Date().toLocaleTimeString('en-US', {hour12: false, hour: "numeric", minute: "numeric", second: "numeric"});
            logDiv.innerHTML += `<div>[${time}] ${msg}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function connectDevice(mode) {
            try {
                log(`嘗試連接 (模式${mode})...`);
                statusBadge.className = 'status-badge status-scanning';
                statusBadge.innerText = '搜尋中';

                let options = {};
                // 使用標準心率 UUID
                const HEART_RATE_SERVICE_UUID = 0x180D;
                const HEART_RATE_MEASUREMENT_CHARACTERISTIC = 0x2A37;

                if (mode === 'A') {
                    options = {
                        filters: [{ services: [HEART_RATE_SERVICE_UUID] }]
                    };
                } else {
                    options = {
                        acceptAllDevices: true,
                        optionalServices: [HEART_RATE_SERVICE_UUID]
                    };
                }

                bluetoothDevice = await navigator.bluetooth.requestDevice(options);

                log(`已選取: ${bluetoothDevice.name}`);
                bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);

                log('連接中 (若失敗將自動重試)...');
                
                // --- 重試機制 (Retry Logic) ---
                let server = null;
                const maxRetries = 3;
                
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        server = await bluetoothDevice.gatt.connect();
                        log('GATT 連接成功！');
                        break; // 成功，跳出迴圈
                    } catch (err) {
                        console.warn(`Attempt ${i + 1} failed:`, err);
                        if (i < maxRetries - 1) {
                            log(`嘗試 ${i + 1} 失敗，1.5秒後重試...`);
                            await new Promise(resolve => setTimeout(resolve, 1500));
                        } else {
                            throw err;
                        }
                    }
                }

                if (!server) {
                    throw new Error("無法建立 GATT 伺服器連線");
                }

                // --- 關鍵修正：加入穩定性等待 ---
                log('等待裝置穩定 (2秒)...');
                await new Promise(resolve => setTimeout(resolve, 2000));

                log('取得服務...');
                // 使用明確的 UUID 而不是別名
                const service = await server.getPrimaryService(HEART_RATE_SERVICE_UUID);

                log('取得特徵值...');
                const characteristic = await service.getCharacteristic(HEART_RATE_MEASUREMENT_CHARACTERISTIC);

                log('啟動監聽...');
                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', handleHeartRateMeasurement);
                heartRateCharacteristic = characteristic; // 保存起來供後續使用

                statusBadge.className = 'status-badge status-connected';
                statusBadge.innerText = '已連接';
                
                // Disable buttons
                connectBtn.disabled = true;
                connectBtnAll.disabled = true;
                connectBtn.classList.add('opacity-50', 'cursor-not-allowed');
                connectBtnAll.classList.add('opacity-50', 'cursor-not-allowed');
                
                stopSimulation();

            } catch (error) {
                console.error(error);
                statusBadge.className = 'status-badge status-disconnected';
                statusBadge.innerText = '失敗';
                
                if (error.name === 'NotFoundError') {
                    log('提示: 您取消了選取或未找到裝置');
                } else if (error.name === 'SecurityError') {
                    log('⚠️ 環境限制: 預覽視窗不支援藍牙。');
                    alert("⚠️ 預覽環境限制\n\n請將檔案上傳至 GitHub Pages 進行測試。");
                } else {
                    // 修正 undefined 錯誤訊息
                    const errorMsg = error.message || error.toString();
                    log('錯誤: ' + errorMsg);
                    
                    if (errorMsg.includes("Service not found")) {
                        log('❌ 找不到心率服務。');
                        log('可能原因：');
                        log('1. 手錶未在廣播模式');
                        log('2. 請嘗試「忘記此裝置」後重連');
                    }
                }
            }
        }

        function handleHeartRateMeasurement(event) {
            const value = event.target.value;
            parseHeartRate(value);
        }

        function parseHeartRate(value) {
            const flags = value.getUint8(0);
            const rate16Bits = flags & 0x1;
            let heartRate;
            let offset = 1;
            
            if (rate16Bits) {
                heartRate = value.getUint16(offset, true);
                offset += 2;
            } else {
                heartRate = value.getUint8(offset);
                offset += 1;
            }

            const rrPresent = flags & 0x10;
            let rrInterval = null;
            if (rrPresent) {
                const energyPresent = flags & 0x8;
                if (energyPresent) offset += 2;

                while (offset + 1 < value.byteLength) {
                    const rawRR = value.getUint16(offset, true);
                    rrInterval = Math.round((rawRR / 1024) * 1000);
                    offset += 2;
                }
            }
            updateStats(heartRate, rrInterval);
        }

        function onDisconnected(event) {
            log('裝置已斷開');
            statusBadge.className = 'status-badge status-disconnected';
            statusBadge.innerText = '已斷開';
            connectBtn.disabled = false;
            connectBtnAll.disabled = false;
            connectBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            connectBtnAll.classList.remove('opacity-50', 'cursor-not-allowed');
        }

        // --- 模擬模式 ---
        function startSimulation() {
            if (isSimulating) return;
            isSimulating = true;
            log('啟動模擬');
            let simHR = 70;
            let simRR = 850; 
            simulationInterval = setInterval(() => {
                const now = Date.now() / 1000;
                const breathPhase = Math.sin(now * (Math.PI * 2 / BREATH_CYCLE_SEC));
                simRR = 850 + (breathPhase * 100) + (Math.random() - 0.5) * 50;
                simHR = Math.round(60000 / simRR);
                updateStats(simHR, Math.round(simRR));
            }, 1000);
        }

        function stopSimulation() {
            isSimulating = false;
            clearInterval(simulationInterval);
            simulateBtn.innerText = "測試介面 (模擬數據)";
            simulateBtn.classList.remove('bg-green-600');
        }

        // Event Listeners
        connectBtn.addEventListener('click', () => connectDevice('A'));
        connectBtnAll.addEventListener('click', () => connectDevice('B'));
        
        simulateBtn.addEventListener('click', () => {
            if (isSimulating) {
                stopSimulation();
            } else {
                startSimulation();
                simulateBtn.innerText = "停止模擬";
                simulateBtn.classList.add('bg-green-600');
            }
        });

    </script>
</body>
</html>
